$:.unshift("../../lib")

require "motion/project/template/#{ENV['PLATFORM'] || 'ios'}"

ENV['output'] ||= 'pretty_spec_dox'

Motion::Project::App.setup do |app|
  # Use `rake config' to see complete project settings.
  app.name = 'test'
  app.frameworks += ['AddressBook', 'AddressBookUI', 'AudioToolbox', 'AVFoundation', 'CoreData', 'CoreMIDI', 'GameKit']
  app.vendor_project('vendor/code', :static)

  app.spec_files.insert(1, *FileList['../helpers/*.rb'])
  app.deployment_target = ENV['deployment_target'] if ENV['deployment_target']

  app.archs[app.local_platform] = [ENV['ARCH']] if ENV['ARCH']

  # 10.8 and 10.9 are 64-bit only.
  if ENV['PLATFORM'] == 'osx' && ENV['ARCH'] == 'i386'
    app.deployment_target = '10.7' # TODO 10.6?
  end
end

task :clean do
  if ENV['ARCH']
    dir = "./vendor/code/build-#{App.config.local_platform}"
    if File.exist?(dir)
      App.info 'Delete', dir
      FileUtils.rm_rf dir
    end
  end
end

namespace :spec do
  task :clean_run => [:clean, :spec]

  test_fail_count = []

  task :install_aggregate_test_handler do
    at_exit do
      count = test_fail_count.inject(0) { |i, sum| sum + i }
      if test_fail_count.size > 1
        App.info "TESTING", "A total of #{count} failures/errors occurred"
      end
      exit count
    end
  end

  platforms = [:ios, :osx]
  archs = { '32' => 'i386', '64' => 'x86_64' }

  platforms.each do |platform|
    namespace platform do
      archs.each do |bit, arch|
        desc "Run tests on #{platform} with arch #{bit}-bit"
        task bit => :install_aggregate_test_handler do
          App.info "TESTING", "Running test suite on platform: #{platform} (#{bit}-bit)"
          begin
            sh "env PLATFORM=#{platform} ARCH=#{arch} rake spec:clean_run"
          rescue RuntimeError
            test_fail_count << $?.exitstatus
          end
        end
      end
    end
  end

  platforms.each do |platform|
    desc "Run tests on #{platform} with all archs"
    task platform => archs.keys.map { |arch| "spec:#{platform}:#{arch}" }
  end

  archs.keys.each do |arch|
    desc "Run tests on all platforms with arch #{arch}-bit"
    task arch => platforms.map { |platform| "spec:#{platform}:#{arch}" }
  end

  desc 'Run tests on all platforms and with all archs'
  task :all => [:ios, :osx]
end

# TODO enable this once full test suite works on OS X.
#task :default => 'spec:all'
